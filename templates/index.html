<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CestariChat â€” AI Interface</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;500&family=Figtree:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    id="hljs-theme">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    /* â”€â”€â”€ CSS Variables / Themes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-tertiary: #1a1a24;
      --bg-card: #16161f;
      --border: #2a2a3a;
      --border-accent: #3d3d55;
      --text-primary: #e8e8f0;
      --text-secondary: #8888a8;
      --text-muted: #55556a;
      --accent: #7c6af7;
      --accent-glow: rgba(124, 106, 247, 0.25);
      --accent-alt: #f06292;
      --user-bubble: #1e1a3a;
      --user-border: #3d3560;
      --ai-bubble: #16161f;
      --ai-border: #2a2a3a;
      --token-bg: #0f1a2a;
      --token-text: #4fc3f7;
      --danger: #ef5350;
      --success: #66bb6a;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      --radius: 16px;
      --radius-sm: 8px;
      --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.theme-light {
      --bg-primary: #f0f0f8;
      --bg-secondary: #e8e8f4;
      --bg-tertiary: #dcdcee;
      --bg-card: #fafaff;
      --border: #d0d0e4;
      --border-accent: #b8b8d4;
      --text-primary: #1a1a2e;
      --text-secondary: #5555780;
      --text-muted: #9090aa;
      --accent: #5c4fd6;
      --accent-glow: rgba(92, 79, 214, 0.15);
      --accent-alt: #d63f84;
      --user-bubble: #ede9ff;
      --user-border: #c5bcff;
      --ai-bubble: #fafaff;
      --ai-border: #d0d0e4;
      --token-bg: #e8f4ff;
      --token-text: #0277bd;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    body.theme-aurora {
      --bg-primary: #020d1a;
      --bg-secondary: #051524;
      --bg-tertiary: #082030;
      --bg-card: #061c2c;
      --border: #0d3048;
      --border-accent: #164a6e;
      --text-primary: #d4f5e9;
      --text-secondary: #6ba8a0;
      --text-muted: #3a6868;
      --accent: #00e5b0;
      --accent-glow: rgba(0, 229, 176, 0.2);
      --accent-alt: #ff6b9d;
      --user-bubble: #071f30;
      --user-border: #0d4060;
      --ai-bubble: #061c2c;
      --ai-border: #0d3048;
      --token-bg: #051820;
      --token-text: #00e5b0;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    body.theme-ember {
      --bg-primary: #120808;
      --bg-secondary: #1c0f0a;
      --bg-tertiary: #26150f;
      --bg-card: #1e1109;
      --border: #3a2218;
      --border-accent: #5a3520;
      --text-primary: #f5e6dc;
      --text-secondary: #b08070;
      --text-muted: #6a4535;
      --accent: #ff6d3a;
      --accent-glow: rgba(255, 109, 58, 0.2);
      --accent-alt: #ffc107;
      --user-bubble: #2a1510;
      --user-border: #5a2e1a;
      --ai-bubble: #1e1109;
      --ai-border: #3a2218;
      --token-bg: #1a0f05;
      --token-text: #ffab76;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Figtree', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background var(--transition), color var(--transition);
    }

    #app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 100vh;
      height: 100vh;
    }

    #sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background var(--transition), border-color var(--transition);
    }

    .sidebar-header {
      padding: 24px 20px 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .logo-name {
      font-family: 'DM Serif Display', serif;
      font-size: 22px;
      letter-spacing: -0.5px;
      color: var(--text-primary);
    }

    .logo-tagline {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      font-family: 'JetBrains Mono', monospace;
    }

    .sidebar-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .custom-select {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      padding: 8px 12px;
      font-family: 'Figtree', sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: border-color var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .custom-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .theme-btn {
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 12px;
      font-family: 'Figtree', sans-serif;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .theme-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .theme-btn.active {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--accent);
    }

    .theme-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .token-panel {
      margin: 0 20px;
      padding: 12px;
      background: var(--token-bg);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }

    .token-panel-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
    }

    .token-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
    }

    .token-label {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    .token-value {
      font-size: 12px;
      color: var(--token-text);
      font-weight: 500;
      font-family: 'JetBrains Mono', monospace;
    }

    .sidebar-spacer {
      flex: 1;
    }

    .new-chat-btn {
      margin: 16px 20px;
      padding: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      font-family: 'Figtree', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity var(--transition), transform var(--transition);
      letter-spacing: 0.3px;
    }

    .new-chat-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    #main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-primary);
    }

    #chat-header {
      padding: 16px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
      transition: background var(--transition);
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .chat-title {
      font-size: 15px;
      font-weight: 600;
    }

    .chat-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .provider-badge {
      padding: 4px 12px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 20px;
      font-size: 11px;
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar {
      width: 4px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: var(--border-accent);
      border-radius: 2px;
    }

    .message-group {
      display: flex;
      gap: 14px;
      animation: msg-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes msg-in {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-group.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .avatar-ai {
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      box-shadow: 0 0 16px var(--accent-glow);
    }

    .avatar-user {
      background: var(--user-bubble);
      border: 1px solid var(--user-border);
    }

    .message-content {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message-group.user .message-content {
      align-items: flex-end;
    }

    .message-meta {
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      padding: 0 4px;
    }

    .bubble {
      padding: 14px 18px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.65;
      word-break: break-word;
      transition: background var(--transition), border-color var(--transition);
    }

    .bubble-ai {
      background: var(--ai-bubble);
      border: 1px solid var(--ai-border);
      border-top-left-radius: 4px;
      box-shadow: var(--shadow);
    }

    .bubble-user {
      background: var(--user-bubble);
      border: 1px solid var(--user-border);
      border-top-right-radius: 4px;
    }

    /* Code blocks inside bubbles */
    .bubble pre {
      margin: 10px 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: #1a1a2e;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
    }

    .copy-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background var(--transition);
    }

    .copy-btn:hover {
      background: var(--accent-glow);
    }

    .bubble pre code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      display: block;
      padding: 14px !important;
    }

    .bubble code:not(pre code) {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 1px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--accent);
    }

    .bubble p {
      margin: 6px 0;
    }

    .bubble p:first-child {
      margin-top: 0;
    }

    .bubble p:last-child {
      margin-bottom: 0;
    }

    .file-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .file-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    .file-icon {
      font-size: 13px;
    }

    /* Token inline badge */
    .token-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      background: var(--token-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 10px;
      color: var(--token-text);
      font-family: 'JetBrains Mono', monospace;
    }

    .typing-indicator .bubble-ai {
      padding: 16px 18px;
    }

    .dots {
      display: flex;
      gap: 4px;
    }

    .dots span {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1.2s ease-in-out infinite;
    }

    .dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0.6);
        opacity: 0.4;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Empty state */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      opacity: 0.5;
      pointer-events: none;
    }

    .empty-icon {
      font-size: 52px;
    }

    .empty-title {
      font-family: 'DM Serif Display', serif;
      font-size: 22px;
    }

    .empty-sub {
      font-size: 13px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    #input-area {
      padding: 16px 28px 24px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
      transition: background var(--transition);
    }

    #file-preview-bar {
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .preview-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    .preview-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0 2px;
      border-radius: 50%;
      transition: color var(--transition);
    }

    .preview-remove:hover {
      color: var(--danger);
    }

    #input-box {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      transition: border-color var(--transition);
    }

    #input-box:focus-within {
      border-color: var(--accent);
    }

    #message-input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text-primary);
      font-family: 'Figtree', sans-serif;
      font-size: 14px;
      resize: none;
      max-height: 140px;
      min-height: 22px;
      line-height: 1.5;
      outline: none;
    }

    #message-input::placeholder {
      color: var(--text-muted);
    }

    #message-input::-webkit-scrollbar {
      width: 3px;
    }

    #message-input::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .input-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .icon-btn-upload {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .icon-btn-upload:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .icon-btn-send {
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .icon-btn-send:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    .icon-btn-send:disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    #file-input {
      display: none;
    }

    #toast {
      position: fixed;
      bottom: 80px;
      right: 28px;
      padding: 10px 16px;
      background: var(--danger);
      color: white;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 100;
    }

    #toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    @media (max-width: 768px) {
      #app {
        grid-template-columns: 1fr;
      }

      #sidebar {
        display: none;
      }
    }
  </style>
</head>

<body class="theme-dark">

  <div id="app">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
              width="24px" fill="#e3e3e3">
              <path
                d="m354-287 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-120l65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm247-350Z" />
            </svg></div>
          <span class="logo-name">CestariChat</span>
        </div>
        <div class="logo-tagline">IA Gemini</div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Proveedor</div>
        <select class="custom-select" id="provider-select">
          <option value="gemini">Google Gemini</option>
        </select>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Modelo</div>
        <select class="custom-select" id="model-select">
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4o-mini">gpt-4o-mini</option>
          <option value="gpt-4-turbo">gpt-4-turbo</option>
          <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        </select>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-label">Tema</div>
        <div class="theme-grid">
          <button class="theme-btn active" data-theme="theme-dark" onclick="setTheme('theme-dark', this)">
            <span class="theme-dot" style="background:#7c6af7"></span> Oscuro
          </button>
          <button class="theme-btn" data-theme="theme-light" onclick="setTheme('theme-light', this)">
            <span class="theme-dot" style="background:#5c4fd6"></span> Claro
          </button>
          <button class="theme-btn" data-theme="theme-aurora" onclick="setTheme('theme-aurora', this)">
            <span class="theme-dot" style="background:#00e5b0"></span> Aurora
          </button>
          <button class="theme-btn" data-theme="theme-ember" onclick="setTheme('theme-ember', this)">
            <span class="theme-dot" style="background:#ff6d3a"></span> Ember
          </button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="token-panel">
          <div class="token-panel-title">// Token Usage</div>
          <div class="token-row">
            <span class="token-label">input</span>
            <span class="token-value" id="stat-input">â€”</span>
          </div>
          <div class="token-row">
            <span class="token-label">output</span>
            <span class="token-value" id="stat-output">â€”</span>
          </div>
          <div class="token-row">
            <span class="token-label">total (sesiÃ³n)</span>
            <span class="token-value" id="stat-total">0</span>
          </div>
          <div class="token-row">
            <span class="token-label">modelo</span>
            <span class="token-value" id="stat-model" style="font-size:10px">â€”</span>
          </div>
        </div>
      </div>

      <div class="sidebar-spacer"></div>

      <button class="new-chat-btn" onclick="clearChat()">+ Nueva ConversaciÃ³n</button>
    </aside>

    <!-- Main -->
    <main id="main">
      <div id="chat-header">
        <div class="chat-header-info">
          <div class="status-dot"></div>
          <div>
            <div class="chat-title">ConversaciÃ³n activa</div>
            <div class="chat-subtitle" id="header-subtitle">Listo para responder</div>
          </div>
        </div>
      </div>

      <div id="messages">
        <div id="empty-state">
          <div class="empty-icon"><svg xmlns="http://www.w3.org/2000/svg" height="78px" viewBox="0 -960 960 960"
              width="78px" fill="#e3e3e3">
              <path
                d="m323-245 157-94 157 95-42-178 138-120-182-16-71-168-71 167-182 16 138 120-42 178Zm-90 125 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm247-355Z" />
            </svg></div>
          <div class="empty-title">Comienza una conversaciÃ³n</div>
          <div class="empty-sub">Soporta texto, cÃ³digo e imÃ¡genes</div>
        </div>
      </div>

      <div id="input-area">
        <div id="file-preview-bar"></div>
        <div id="input-box">
          <textarea id="message-input" placeholder="Escribe tu mensaje... (Shift+Enter para nueva lÃ­nea)"
            rows="1"></textarea>
          <div class="input-actions">
            <label for="file-input" class="icon-btn icon-btn-upload" title="Adjuntar archivo">ðŸ“Ž</label>
            <input type="file" id="file-input" multiple accept="image/*,audio/*,.pdf,.txt">
            <button class="icon-btn icon-btn-send" id="send-btn" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast"></div>

  <script>
    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let conversationHistory = [];
    let selectedFiles = [];
    let sessionTokens = 0;

    // â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setTheme(theme, btn) {
      const themes = ['theme-dark', 'theme-light', 'theme-aurora', 'theme-ember'];
      themes.forEach(t => document.body.classList.remove(t));
      document.body.classList.add(theme);
      document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const hljsTheme = document.getElementById('hljs-theme');
      if (theme === 'theme-light') {
        hljsTheme.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
      } else {
        hljsTheme.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
      }
    }

    // â”€â”€â”€ Provider/Model sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const providerModels = {
      openai: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo'],
      gemini: ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro']
    };

    document.getElementById('provider-select').addEventListener('change', function () {
      const models = providerModels[this.value] || [];
      const sel = document.getElementById('model-select');
      sel.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
      updateBadge();
    });

    function updateBadge() {
      const p = document.getElementById('provider-select').value;
      const m = document.getElementById('model-select').value;
      const names = { openai: 'OpenAI', gemini: 'Gemini' };
      document.getElementById('header-badge').textContent = `${names[p] || p} Â· ${m}`;
    }
    document.getElementById('model-select').addEventListener('change', updateBadge);

    // â”€â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('file-input').addEventListener('change', function () {
      Array.from(this.files).forEach(f => {
        if (!selectedFiles.find(sf => sf.name === f.name)) {
          selectedFiles.push(f);
        }
      });
      renderFilePreviews();
      this.value = '';
    });

    function renderFilePreviews() {
      const bar = document.getElementById('file-preview-bar');
      if (selectedFiles.length === 0) {
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'flex';
      bar.innerHTML = selectedFiles.map((f, i) => `
    <div class="preview-chip">
      <span>${getFileIcon(f.type)}</span>
      <span>${f.name.length > 20 ? f.name.slice(0, 18) + 'â€¦' : f.name}</span>
      <button class="preview-remove" onclick="removeFile(${i})">Ã—</button>
    </div>
  `).join('');
    }

    function removeFile(idx) {
      selectedFiles.splice(idx, 1);
      renderFilePreviews();
    }

    function getFileIcon(type) {
      if (type.startsWith('image/')) return 'ðŸ–¼';
      if (type.startsWith('audio/')) return 'ðŸŽµ';
      if (type.startsWith('video/')) return 'ðŸŽ¥';
      if (type === 'application/pdf') return 'ðŸ“„';
      return 'ðŸ“Ž';
    }

    // â”€â”€â”€ Textarea auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const textarea = document.getElementById('message-input');
    textarea.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 140) + 'px';
    });

    textarea.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // â”€â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
      const input = textarea.value.trim();
      if (!input && selectedFiles.length === 0) return;

      const provider = document.getElementById('provider-select').value;
      const model = document.getElementById('model-select').value;

      // Hide empty state
      document.getElementById('empty-state').style.display = 'none';

      // Add user message to UI
      const filesSnapshot = [...selectedFiles];
      addMessage('user', input, filesSnapshot);

      // Add to history
      conversationHistory.push({ role: 'user', content: input });

      // Clear input
      textarea.value = '';
      textarea.style.height = 'auto';
      selectedFiles = [];
      renderFilePreviews();

      // Show typing
      const typingId = addTyping();
      document.getElementById('send-btn').disabled = true;
      document.getElementById('header-subtitle').textContent = 'Generando respuesta...';

      try {
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('model', model);
        formData.append('messages', JSON.stringify(conversationHistory));
        filesSnapshot.forEach(f => formData.append('files', f));

        const res = await fetch('/api/chat', { method: 'POST', body: formData });
        const data = await res.json();

        removeTyping(typingId);

        if (!data.success) throw new Error(data.error || 'Error desconocido');

        // Update history with AI reply
        conversationHistory.push({ role: 'assistant', content: data.reply });

        // Render AI message
        addMessage('ai', data.reply, data.files || [], data.tokens);

        // Update token stats
        if (data.tokens) {
          document.getElementById('stat-input').textContent = data.tokens.input?.toLocaleString() || 'â€”';
          document.getElementById('stat-output').textContent = data.tokens.output?.toLocaleString() || 'â€”';
          sessionTokens += data.tokens.total || 0;
          document.getElementById('stat-total').textContent = sessionTokens.toLocaleString();
          document.getElementById('stat-model').textContent = data.model;
        }

        document.getElementById('header-subtitle').textContent = `Respuesta de ${data.provider}`;

      } catch (err) {
        removeTyping(typingId);
        showToast(err.message);
        document.getElementById('header-subtitle').textContent = 'Error al conectar';
      }

      document.getElementById('send-btn').disabled = false;
    }

    // â”€â”€â”€ Message Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addMessage(role, text, files = [], tokens = null) {
      const container = document.getElementById('messages');
      const isAI = role === 'ai';

      const group = document.createElement('div');
      group.className = `message-group ${isAI ? 'ai' : 'user'}`;

      const now = new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });

      let fileChips = '';
      if (files.length > 0) {
        fileChips = `<div class="file-chips">${files.map(f => `
      <div class="file-chip">
        <span class="file-icon">${getFileIcon(f.type || '')}</span>
        <span>${f.name || f.name}</span>
        ${f.size_readable ? `<span style="opacity:.6">${f.size_readable}</span>` : ''}
      </div>
    `).join('')}</div>`;
      }

      let tokenBadge = '';
      if (tokens && isAI) {
        tokenBadge = `<div class="token-badge">
      â†‘ ${tokens.input?.toLocaleString() || 0} &nbsp;Â·&nbsp; â†“ ${tokens.output?.toLocaleString() || 0} &nbsp;Â·&nbsp; Î£ ${tokens.total?.toLocaleString() || 0} tokens
    </div>`;
      }

      const formattedText = isAI ? formatMarkdown(text) : escapeHtml(text).replace(/\n/g, '<br>');

      group.innerHTML = `
    <div class="avatar ${isAI ? 'avatar-ai' : 'avatar-user'}">${isAI ? 'âœ¦' : 'â—‰'}</div>
    <div class="message-content">
      <div class="message-meta">${isAI ? 'NeuralChat' : 'TÃº'} Â· ${now}</div>
      <div class="bubble ${isAI ? 'bubble-ai' : 'bubble-user'}">
        ${text ? formattedText : ''}
        ${fileChips}
      </div>
      ${tokenBadge}
    </div>
  `;

      container.appendChild(group);
      container.scrollTop = container.scrollHeight;

      // Highlight code blocks
      group.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    }

    function addTyping() {
      const id = 'typing-' + Date.now();
      const container = document.getElementById('messages');
      const group = document.createElement('div');
      group.className = 'message-group ai typing-indicator';
      group.id = id;
      group.innerHTML = `
    <div class="avatar avatar-ai">âœ¦</div>
    <div class="message-content">
      <div class="bubble bubble-ai"><div class="dots"><span></span><span></span><span></span></div></div>
    </div>`;
      container.appendChild(group);
      container.scrollTop = container.scrollHeight;
      return id;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    // â”€â”€â”€ Markdown Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatMarkdown(text) {
      // Code blocks with language detection
      text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
        const language = lang || 'plaintext';
        return `<pre><div class="code-header"><span>${language}</span><button class="copy-btn" onclick="copyCode(this)">Copiar</button></div><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
      });

      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Bold
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');

      // Italic
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Paragraphs (split on double newline)
      const blocks = text.split(/\n\n+/);
      return blocks.map(block => {
        if (block.startsWith('<pre>')) return block;
        // Lines
        const lines = block.split('\n').join('<br>');
        return `<p>${lines}</p>`;
      }).join('');
    }

    function escapeHtml(text) {
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function copyCode(btn) {
      const code = btn.closest('pre').querySelector('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'âœ“ Copiado';
        setTimeout(() => btn.textContent = 'Copiar', 2000);
      });
    }

    // â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function clearChat() {
      conversationHistory = [];
      sessionTokens = 0;
      document.getElementById('messages').innerHTML = `
    <div id="empty-state">
      <div class="empty-icon">âœ¦</div>
      <div class="empty-title">Comienza una conversaciÃ³n</div>
      <div class="empty-sub">// Soporta texto, cÃ³digo e imÃ¡genes</div>
    </div>`;
      ['stat-input', 'stat-output', 'stat-model'].forEach(id => document.getElementById(id).textContent = 'â€”');
      document.getElementById('stat-total').textContent = '0';
      document.getElementById('header-subtitle').textContent = 'Listo para responder';
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = 'âš  ' + msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    // â”€â”€â”€ Load available models from backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadModels() {
      try {
        const res = await fetch('/api/models');
        const data = await res.json();
        if (Object.keys(data).length > 0) {
          Object.assign(providerModels, data);
          // Update selects
          const provSel = document.getElementById('provider-select');
          provSel.innerHTML = Object.keys(data).map(p => {
            const names = { openai: 'âš¡ OpenAI', gemini: 'â—ˆ Google Gemini' };
            return `<option value="${p}">${names[p] || p}</option>`;
          }).join('');
          provSel.dispatchEvent(new Event('change'));
        }
      } catch (e) { }
    }

    loadModels();
  </script>
</body>

</html>